/**
* @license Apache-2.0
*
* Copyright (c) 2022 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

'use strict';

// MODULES //

var objectEntries = require( '@stdlib/utils/entries' );


// VARIABLES //

var idToUrl = null;


// FUNCTIONS //

/**
* Creates a mapping from link identifiers to link URLs and stores the mapping in  variable `idToUrl`.
*
* @private
* @param {Object} db - link database mapping link URLs to metadata
*/
function createIdToUrl( db ) {
	var entries;
	var i;

	idToUrl = {};
	entries = objectEntries( db );
	for ( i = 0; i < entries.length; i++ ) {
		idToUrl[ entries[ i ][ 1 ].id ] = entries[ i ][ 0 ];
	}
}


// MAIN //

/**
* Validates an array of link objects against a link database.
*
* @private
* @param {ObjectArray} links - array of link objects to validate
* @param {Object} db - link database mapping link URLs to metadata
* @returns {ObjectArray} array of validation errors
*/
function check( links, db ) {
	var link;
	var out;
	var msg;
	var url;
	var id;
	var i;

	out = [];
	for ( i = 0; i < links.length; i++ ) {
		link = links[ i ];
		url = link.url;
		id = link.id;
		if ( !db[ url ] ) {
			if ( !idToUrl ) {
				createIdToUrl( db );
			}
			msg = 'Entry not found in database';
			if ( idToUrl[ id ] ) {
				msg += '. Did you mean to use URL `'+idToUrl[ id ]+'`?';
			}
			out.push({
				'error': msg,
				'id': id,
				'url': url
			});
		}
		else if ( db[ url ].id !== id ) {
			out.push({
				'error': 'Mismatched link identifier',
				'id': id,
				'url': url,
				'expected': db[ url ].id
			});
		}
	}
	return out;
}


// EXPORTS //

module.exports = check;
