/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

/**
* Functionality for creating, and interfacing with, strided array function objects.
*/
#include "stdlib/strided/common/function_object.h"
#include "stdlib/strided/common/function_typedefs.h"
#include <stdlib.h>
#include <stdint.h>

/**
* Returns a pointer to a dynamically allocated strided array function object.
*
* ## Notes
*
* -   The user is responsible for freeing the allocated memory.
*
* @param name        strided array function name
* @param nin         number of input strided arrays
* @param nout        number of output strided arrays
* @param functions   array containing strided array functions
* @param nfunctions  number of strided array functions
* @param types       array of type "numbers", where the total number of types equals `(nin+nout)*nfunctions` and where each set of `nin+nout` consecutive types (non-overlapping) corresponds to the set of strided array argument types for a corresponding strided array function
* @param data        array of void pointers corresponding to the "data" (e.g., callbacks) which should be passed to a respective strided array function
* @return            pointer to a dynamically allocated strided array function object or, if unable to allocate memory, a null pointer
*
* @example
* #include "stdlib/strided/common/function_typedefs.h"
* #include "stdlib/strided/common/binary.h"
* #include "stdlib/ndarray/dtypes.h"
* #include <stdlib.h>
* #include <stdio.h>
*
* // Define the function(s) we want to apply to strided arrays:
* double add( double x, double y ) {
*     return x + y;
* }
*
* // Define a function name:
* const char name[] = "binary_strided_array_function";
*
* // Define a list of strided array functions (in this case, as the function to be applied accepts doubles, we only use strided array functions which handle doubles as function arguments and, for the purposes of this example, we assume that the output strided array is (almost) always a double-precision floating-point number array):
* StridedArrayFcn functions[] = {
*     stdlib_strided_dd_d,
*     stdlib_strided_ff_f_as_dd_d,
*     stdlib_strided_II_d_as_dd_d,
*     stdlib_strided_ii_d_as_dd_d,
*     stdlib_strided_HH_d_as_dd_d,
*     stdlib_strided_hh_d_as_dd_d,
*     stdlib_strided_BB_d_as_dd_d,
*     stdlib_strided_bb_d_as_dd_d
* };
*
* // Define the **strided array** argument types for each strided array function:
* int types[] = {
*     STDLIB_NDARRAY_FLOAT64, STDLIB_NDARRAY_FLOAT64, STDLIB_NDARRAY_FLOAT64,
*     STDLIB_NDARRAY_FLOAT32, STDLIB_NDARRAY_FLOAT32, STDLIB_NDARRAY_FLOAT32,
*     STDLIB_NDARRAY_UINT32, STDLIB_NDARRAY_UINT32, STDLIB_NDARRAY_FLOAT64,
*     STDLIB_NDARRAY_INT32, STDLIB_NDARRAY_INT32, STDLIB_NDARRAY_FLOAT64,
*     STDLIB_NDARRAY_UINT16, STDLIB_NDARRAY_UINT16, STDLIB_NDARRAY_FLOAT64,
*     STDLIB_NDARRAY_INT16, STDLIB_NDARRAY_INT16, STDLIB_NDARRAY_FLOAT64,
*     STDLIB_NDARRAY_UINT8, STDLIB_NDARRAY_UINT8, STDLIB_NDARRAY_FLOAT64,
*     STDLIB_NDARRAY_INT8, STDLIB_NDARRAY_INT8, STDLIB_NDARRAY_FLOAT64
* };
*
* // Define a list of strided array function "data" (in this case, callbacks):
* void *data[] = {
*     (void *)add,
*     (void *)add,
*     (void *)add,
*     (void *)add,
*     (void *)add,
*     (void *)add,
*     (void *)add,
*     (void *)add
* };
*
* // Create a new strided function object:
* struct StridedFunctionObject *obj = stdlib_strided_function_allocate( name, 2, 1, functions, 8, types, data );
* if ( obj == NULL ) {
*     fprintf( stderr, "Error allocating memory.\n" );
*     exit( 1 );
* }
*
* // Free allocated memory:
* stdlib_strided_function_free( obj );
*/
struct StridedFunctionObject * stdlib_strided_function_allocate( const char *name, uint32_t nin, uint32_t nout, StridedArrayFcn *functions, uint32_t nfunctions, int *types, void *data[] ) {
	struct StridedFunctionObject *obj = malloc( sizeof( struct StridedFunctionObject ) );
	if ( obj == NULL ) {
		return NULL;
	}
	obj->name = name;
	obj->nin = nin;
	obj->nout = nout;
	obj->narrays = nin + nout;
	obj->functions = functions;
	obj->nfunctions = nfunctions;
	obj->types = types;
	obj->data = data;
	return obj;
}

/**
* Frees a strided array function object's allocated memory.
*
* @param obj  strided array function object
*
* @example
* #include "stdlib/strided/common/function_typedefs.h"
* #include "stdlib/strided/common/binary.h"
* #include "stdlib/ndarray/dtypes.h"
* #include <stdlib.h>
* #include <stdio.h>
*
* // Define the function(s) we want to apply to strided arrays:
* double add( double x, double y ) {
*     return x + y;
* }
*
* // Define a function name:
* const char name[] = "binary_strided_array_function";
*
* // Define a list of strided array functions:
* StridedArrayFcn functions[] = {
*     stdlib_strided_dd_d
* };
*
* // Define the **strided array** argument types for each strided array function:
* int types[] = {
*     STDLIB_NDARRAY_FLOAT64, STDLIB_NDARRAY_FLOAT64, STDLIB_NDARRAY_FLOAT64
* };
*
* // Define a list of strided array function "data" (in this case, callbacks):
* void *data[] = {
*     (void *)add
* };
*
* // Create a new strided function object:
* struct StridedFunctionObject *obj = stdlib_strided_function_allocate( name, 2, 1, functions, 8, types, data );
* if ( obj == NULL ) {
*     fprintf( stderr, "Error allocating memory.\n" );
*     exit( 1 );
* }
*
* // ...
*
* // Free allocated memory:
* stdlib_strided_function_free( obj );
*/
void stdlib_strided_function_free( struct StridedFunctionObject *obj ) {
	if ( obj == NULL ) {
		return;
	}
	free( obj );
}
