/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*
*
* ## Notice
*
* The original C code and copyright notice are from the [source implementation]{@link http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/mt19937ar.c}. The implementation has been modified for JavaScript.
*
* ```text
* Copyright (C) 1997 - 2002, Makoto Matsumoto and Takuji Nishimura,
* All rights reserved.
*
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions
* are met:
*
*   1. Redistributions of source code must retain the above copyright
*      notice, this list of conditions and the following disclaimer.
*
*   2. Redistributions in binary form must reproduce the above copyright
*      notice, this list of conditions and the following disclaimer in the
*      documentation and/or other materials provided with the distribution.
*
*   3. The names of its contributors may not be used to endorse or promote
*      products derived from this software without specific prior written
*      permission.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
* "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
* A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
* CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
* EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
* PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
* PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
* LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
* NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
* ```
*/

'use strict';

// MODULES //

var max = require( '@stdlib/math/base/special/max' );
var isCollection = require( '@stdlib/assert/is-collection' );
var setReadOnly = require( '@stdlib/utils/define-read-only-property' );
var isPositiveInteger = require( '@stdlib/assert/is-positive-integer' ).isPrimitive;
var UINT32_MAX = require( '@stdlib/constants/math/uint32-max' );
var FLOAT64_MAX_SAFE_INTEGER = require( '@stdlib/constants/math/float64-max-safe-integer' );
var randuint32 = require( './rand_uint32.js' );


// VARIABLES //

var NORMALIZED_NORMALIZATION_CONSTANT = 1.0 / (FLOAT64_MAX_SAFE_INTEGER + 1.0);
var MAX_SEED = UINT32_MAX >>> 0; // asm type annotation
var N = 624;
var M = 397;
var UPPER_MASK = 0x80000000; /* Most significant w-r bits */
var LOWER_MASK = 0x7fffffff; /* Least significant r bits */
var MATRIX_A = 0x9908b0df;
var mag01 = [ 0x0, MATRIX_A ];


// MAIN //

/**
* Returns a 32-bit Mersenne Twister pseudorandom number generator.
*
* ## References
*
* -   Matsumoto, Makoto, and Takuji Nishimura. 1998. "Mersenne Twister: A 623-dimensionally Equidistributed Uniform Pseudo-random Number Generator." _ACM Transactions on Modeling and Computer Simulation_ 8 (1). New York, NY, USA: ACM: 3â€“30. doi:[10.1145/272991.272995][@matsumoto:1998a].
* -   Harase, Shin. 2017. "Conversion of Mersenne Twister to double-precision floating-point numbers." _ArXiv_ abs/1708.06018 (September). <https://arxiv.org/abs/1708.06018>.
*
* [@matsumoto:1998a]: https://doi.org/10.1145/272991.272995
*
*
* @param {PositiveInteger} [seed] - pseudorandom number generator seed
* @throws {TypeError} must provide a positive integer
* @throws {RangeError} must provide a positive integer less than or equal to the maximum unsigned 32-bit integer
* @returns {Function} Mersenne Twister PRNG
*
* @example
* var mt19937 = factory();
*
* var v = mt19937();
* // returns <number>
*
* @example
* // Return a seeded Mersenne Twister PRNG:
* var mt19937 = factory( 1234 );
*
* var v = mt19937();
* // returns 822569775
*/
function factory( seed ) {
	var seedIsArray;
	var state;
	var mti;
	var mt;
	var s;
	var i;
	var j;
	var k;

	if ( arguments.length ) {
		if ( isCollection( seed ) ) {
			seedIsArray = true;
			i = 1;
			j = 0;
			k = max( N, seed.length );
			state = 19650218 >>> 0; // asm type annotation
		} else {
			if ( !isPositiveInteger( seed ) ) {
				throw new TypeError( 'invalid argument. Must provide a positive integer. Value: `' + seed + '`.' );
			}
			if ( seed > MAX_SEED ) {
				throw new RangeError( 'invalid argument. Must provide a positive integer less than or equal to the maximum unsigned 32-bit integer. Value: `' + seed + '`.' );
			}
			state = seed >>> 0; // asm type annotation
		}
	} else {
		state = randuint32() >>> 0; // asm type annotation
	}

	mt = new Array( N );
	mt[ 0 ] = state >>> 0;
	for ( mti = 1; mti < N; mti++ ) {
		s = mt[ mti - 1 ] ^ ( mt[ mti - 1 ] >>> 30 );
		mt[ mti ] = ( ( ( ( (s & 0xffff0000) >>> 16 ) * 1812433253 ) << 16 ) + ( (s & 0x0000ffff) * 1812433253) ) + mti; // eslint-disable-line max-len
		mt[ mti ] >>>= 0;
	}

	if ( seedIsArray ) {
		for ( ; k > 0; k-- ) {
			s = mt[ i - 1 ] ^ ( mt[ i - 1 ] >>> 30 );

			mt[i] = (mt[i] ^ (((((s & 0xffff0000) >>> 16) * 1664525) << 16) + ((s & 0x0000ffff) * 1664525 ))) + seed[j] + j; // eslint-disable-line max-len
			mt[ i ] >>>= 0;
			i += 1;
			j += 1;
			if ( i >= N ) {
				mt[ 0 ] = mt[ N - 1 ];
				i = 1;
			}
			if ( j >= seed.length ) {
				j = 0;
			}
		}

		for ( k = N - 1; k; k-- ) {
			s = mt[ i - 1 ] ^ ( mt[ i - 1 ] >>> 30 );
			mt[i] = (mt[i] ^ (((((s & 0xffff0000) >>> 16) * 1566083941) << 16) + ((s & 0x0000ffff) * 1566083941))) - i; // eslint-disable-line max-len
			mt[ i ] >>>= 0;
			i += 1;
			if ( i >= N ) {
				mt[ 0 ] = mt[ N - 1 ];
				i = 1;
			}
		}
		mt[ 0 ] = 0x80000000;
	}

	setReadOnly( mt19937, 'NAME', 'mt19937' );
	setReadOnly( mt19937, 'SEED', state );
	setReadOnly( mt19937, 'MIN', 1 );
	setReadOnly( mt19937, 'MAX', UINT32_MAX );
	setReadOnly( mt19937, 'normalized', normalized );

	setReadOnly( normalized, 'NAME', mt19937.NAME );
	setReadOnly( normalized, 'SEED', mt19937.SEED );
	setReadOnly( normalized, 'MIN', 0.0 );
	setReadOnly( normalized, 'MAX', ( ( ( UINT32_MAX >>> 5 ) * 67108864.0 ) + ( UINT32_MAX >>> 6 ) ) * NORMALIZED_NORMALIZATION_CONSTANT );

	return mt19937;

	/**
	* Generates a pseudorandom integer on the interval \\( [1,2^{32}-1) \\).
	*
	* @private
	* @returns {PositiveInteger} pseudorandom integer
	*
	* @example
	* var v = mt19937();
	* // returns <number>
	*/
	function mt19937() {
		var kk;
		var y;

		if ( mti >= N ) {
			for ( kk = 0; kk < N - M; kk++ ) {
				y = ( mt[kk] & UPPER_MASK ) | ( mt[kk + 1] & LOWER_MASK );
				mt[kk] = mt[kk + M] ^ ( y >>> 1 ) ^ mag01[y & 0x1];
			}
			for ( ; kk < N - 1; kk++ ) {
				y = ( mt[kk] & UPPER_MASK ) | ( mt[kk + 1] & LOWER_MASK );
				mt[kk] = mt[kk + (M - N)] ^ (y >>> 1) ^ mag01[y & 0x1];
			}
			y = ( mt[N - 1] & UPPER_MASK ) | ( mt[0] & LOWER_MASK );
			mt[N - 1] = mt[M - 1] ^ ( y >>> 1 ) ^ mag01[y & 0x1];
			mti = 0;
		}

		y = mt[ mti ];
		mti += 1;

		/* Tempering */
		y ^= y >>> 11;
		y ^= ( y << 7 ) & 0x9d2c5680;
		y ^= ( y << 15 ) & 0xefc60000;
		y ^= y >>> 18;

		return y >>> 0;
	}

	/**
	* Generates a pseudorandom number on the interval \\( [0,1) \\).
	*
	* @private
	* @returns {number} pseudorandom number
	*
	* @example
	* var v = normalized();
	* // returns <number>
	*/
	function normalized() {
		var x = mt19937() >>> 5;
		var y = mt19937() >>> 6;
		return ( ( x * 67108864.0 ) + y ) * NORMALIZED_NORMALIZATION_CONSTANT;
	}
}


// EXPORTS //

module.exports = factory;
