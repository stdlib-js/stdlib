/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

'use strict';

// MODULES //

var EventEmitter = require( 'events' ).EventEmitter;
var logger = require( 'debug' );
var getKeys = require( 'object-keys' ).shim();
var inherit = require( '@stdlib/utils/inherit' );
var isObject = require( '@stdlib/assert/is-plain-object' );
var isArrayLike = require( '@stdlib/assert/is-array-like' );
var mergeFcn = require( '@stdlib/utils/merge' ).factory;
var defaults = require( './defaults.js' );


// VARIABLES //

var debug = logger( 'sparkline:main' );

var merge = mergeFcn({
	'extend': false
});

// List of private properties (note: keep in alphabetical order):
var PRIVATE_PROPS = [
	'_autoRender',
	'_data',
	'_infinities',
	'_window',
	'_yMax',
	'_yMin'
];


// MAIN //

/**
* Sparkline constructor.
*
* @constructor
* @param {ArrayLike} [data] - sparkline data
* @param {Options} [options] - sparkline options
* @param {boolean} [options.autoRender=false] - indicates whether to re-render on a change event
* @param {ArrayLike} [options.data] - data
* @param {boolean} [options.infinities=false] - boolean indicating whether to encode infinite values
* @param {(PositiveInteger|null)} [options.window] - sliding window size
* @param {(FiniteNumber|null)} [options.yMax] - maximum value of the y-axis domain
* @param {(FiniteNumber|null)} [options.yMin] - minimum value of the y-axis domain
* @throws {TypeError} must provide valid options
* @returns {Sparkline} sparkline instance
*
* @example
* var data = [ 1.0, 5.0, 3.0, 2.0, 4.0, 4.0, 3.0 ];
*
* var chart = Sparkline( data );
*
* @example
* var data = [ 1.0, 5.0, 3.0, 2.0, 4.0, 4.0, 3.0 ];
* var opts = {
*     'data': data
* };
* var chart = Sparkline( opts );
*/
function Sparkline() {
	var options;
	var nargs;
	var opts;
	var keys;
	var self;
	var key;
	var i;

	nargs = arguments.length;
	if ( !(this instanceof Sparkline) ) {
		if ( nargs === 0 ) {
			return new Sparkline();
		}
		if ( nargs === 1 ) {
			return new Sparkline( arguments[ 0 ] );
		}
		return new Sparkline( arguments[ 0 ], arguments[ 1 ] );
	}
	self = this;

	opts = defaults();
	if ( nargs === 0 ) {
		options = {};
	} else if ( nargs === 1 ) {
		if ( isArrayLike( arguments[ 0 ] ) ) {
			options = {
				'data': arguments[ 0 ]
			};
		} else {
			options = arguments[ 0 ];
			if ( !isObject( options ) ) {
				throw new TypeError( 'invalid input argument. Options argument must be an object. Value: `' + options + '`.' );
			}
		}
	} else {
		if ( !isObject( arguments[ 1 ] ) ) {
			throw new TypeError( 'invalid input argument. Options argument must be an object. Value: `' + arguments[ 1 ] + '`.' );
		}
		options = arguments[ 1 ];
		options.data = arguments[ 0 ];
	}
	opts = merge( opts, options );

	debug( 'Creating an instance with the following configuration: %s.', JSON.stringify( opts ) );
	EventEmitter.call( this );

	for ( i = 0; i < PRIVATE_PROPS.length; i++ ) {
		Object.defineProperty( this, PRIVATE_PROPS[i], {
			'configurable': false,
			'enumerable': false,
			'writable': true,
			'value': null
		});
	}

	// Set options...
	keys = getKeys( opts );
	for ( i = 0; i < keys.length; i++ ) {
		key = keys[ i ];
		this[ key ] = opts[ key ];
	}

	// Add event listeners:
	this.on( 'change', onChange );
	this.on( 'render', onRender );

	return this;

	/**
	* Callback invoked upon receiving a change event.
	*
	* @private
	*/
	function onChange() {
		/* eslint-disable no-underscore-dangle */
		debug( 'Received a change event.' );
		if ( self._autoRender ) {
			self.render();
		}
	}

	/**
	* Callback invoked upon receiving a render event.
	*
	* @private
	* @param {*} chart - rendered chart
	*/
	function onRender() {
		debug( 'Received a render event.' );
	}
}

/*
* Inherit from the `EventEmitter` prototype.
*/
inherit( Sparkline, EventEmitter );

/**
* Rendering mode. If `true`, an instance re-renders on each change event.
*
* @name autoRender
* @memberof Sparkline.prototype
* @type {boolean}
* @throws {TypeError} must be a boolean primitive
* @default false
*
* @example
* var chart = new Sparkline({
*     'autoRender': true
* });
*
* var mode = chart.autoRender;
* // returns true
*/
Object.defineProperty( Sparkline.prototype, 'autoRender', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/auto-render/set.js' ),
	'get': require( './props/auto-render/get.js' )
});

/**
* Minimum value of the y-axis domain.
*
* @name yMin
* @memberof Sparkline.prototype
* @type {(FiniteNumber|null)}
* @throws {TypeError} must be a finite number primitive or null
*
* @example
* var chart = new Sparkline();
* chart.yMin = -100.0;
*
* @example
* var chart = new Sparkline({
*     'yMin': 3.14
* });
* var ymin = chart.yMin;
* // returns 3.14
*/
Object.defineProperty( Sparkline.prototype, 'yMin', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/y-min/set.js' ),
	'get': require( './props/y-min/get.js' )
});

/**
* Maximum value of the y-axis domain.
*
* @name yMax
* @memberof Sparkline.prototype
* @type {(FiniteNumber|null)}
* @throws {TypeError} must be a finite number primitive or null
*
* @example
* var chart = new Sparkline();
* chart.yMax = 100.0;
*
* @example
* var chart = new Sparkline({
*     'yMax': 314.0
* });
* var ymax = chart.yMax;
* // returns 314.0
*/
Object.defineProperty( Sparkline.prototype, 'yMax', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/y-max/set.js' ),
	'get': require( './props/y-max/get.js' )
});

/**
* Size of sliding window.
*
* @name window
* @memberof Sparkline.prototype
* @type {(PositiveInteger|null)}
* @throws {TypeError} must be a positive integer
* @throws {Error} must be greater than or equal to the number of data elements
*
* @example
* var chart = new Sparkline();
* chart.window = 20;
*
* @example
* var chart = new Sparkline({
*     'window': 25
* });
* var win = chart.window;
* // returns 25
*/
Object.defineProperty( Sparkline.prototype, 'window', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/window/set.js' ),
	'get': require( './props/window/get.js' )
});

/**
* Boolean indicating whether to encode infinite values.
*
* @name infinities
* @memberof Sparkline.prototype
* @type {boolean}
* @throws {TypeError} must be a boolean primitive
* @default false
*
* @example
* var chart = new Sparkline();
* chart.infinities = true;
*
* @example
* var chart = new Sparkline({
*     'infinities': true
* });
* var bool = chart.infinities;
* // returns true
*/
Object.defineProperty( Sparkline.prototype, 'infinities', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/infinities/set.js' ),
	'get': require( './props/infinities/get.js' )
});

/**
* Sparkline data.
*
* @name data
* @memberof Sparkline.prototype
* @type {(Array|TypedArray)}
* @throws {TypeError} must be an array or typed array
* @throws {Error} length must not exceed maximum sliding window size
*
* @example
* var chart = new Sparkline();
* chart.data = [ 1.0, 0.0, 3.14, 2.0, 5.0 ];
*
* @example
* var data = [ 1.0, 0.0, 3.14, 2.0, 5.0 ];
* var chart = new Sparkline({
*     'data': data
* });
* var d = chart.data;
* // returns [...]
*/
Object.defineProperty( Sparkline.prototype, 'data', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/data/set.js' ),
	'get': require( './props/data/get.js' )
});

/**
* Appends data.
*
* @memberof Sparkline.prototype
* @function push
* @param {*} datum - data to append
* @returns {Sparkline} chart instance
*
* @example
* var data = [ 1.0, 0.0, 3.14, 2.0, 5.0 ];
*
* var chart = new Sparkline({
*     'data': data
* });
*
* chart.push( 6.0 ).push( -3.14 ).push( -1.0 );
*/
Sparkline.prototype.push = require( './push.js' );

/**
* Renders a sparkline.
*
* ## Notes
*
* -   This method **should** be implemented by descendants.
*
* @memberof Sparkline.prototype
* @function render
* @returns {string} rendered sparkline
*/
Sparkline.prototype.render = require( './render.js' );

/**
* Serializes a sparkline as a string.
*
* @memberof Sparkline.prototype
* @function toString
* @returns {string} serialized sparkline
*
* @example
* var data = [ 1.0, 5.0, 3.0, 2.0, 4.0, 4.0, 3.0 ];
*
* var chart = new Sparkline({
*     'data': data
* });
*
* var str = chart.toString();
* // returns '...'
*/
Sparkline.prototype.toString = require( './tostring.js' );


// TODO: stub `toJSON` method, which, similar to `render`, should be implemented by descendants, as will be chart type specific


// EXPORTS //

module.exports = Sparkline;
